{% extends "base.html" %}

{% block title %}Admin - DFS/Props Picks{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4"><i class="bi bi-gear-fill"></i> Admin Configuration</h2>
            
            <!-- Success/Error Messages -->
            {% if request.query_params.get('success') %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill"></i> <strong>Success!</strong> Weekly picks generated successfully.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
            
            {% if request.query_params.get('error') %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i> <strong>Error!</strong> {{ request.query_params.get('error') }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
            
            {% if request.query_params.get('prompt_saved') %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle-fill"></i> <strong>Success!</strong> Prompt template saved successfully.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Single Column Layout -->
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <!-- Configuration Form -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-sliders"></i> Weekly Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="form-group mb-3">
                        <label for="espn_game_data_link" class="form-label">ESPN Game Data Link</label>
                        <input type="url" class="form-control" id="espn_game_data_link" name="espn_game_data_link"
                               value="{{ settings.espn_game_data_link }}" required
                               placeholder="https://www.espn.com/nfl/schedule/_/week/13/year/2025/seasontype/2">
                        <small class="form-text text-muted">
                            ESPN NFL schedule URL for the week you want to analyze.
                        </small>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="slate_description" class="form-label">Slate Description</label>
                        <input type="text" class="form-control" id="slate_description" name="slate_description"
                               value="{{ settings.slate_description }}" required
                               placeholder="e.g., Sunday main slate">
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="note" class="form-label">Note</label>
                        <textarea class="form-control" id="note" name="note" rows="2" required>{{ settings.note }}</textarea>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="focus_games" class="form-label">Focus Games</label>
                        <input type="text" class="form-control" id="focus_games" name="focus_games"
                               value="{{ settings.focus_games }}" required
                               placeholder="all, afternoon_only, or comma-separated list">
                        <small class="form-text text-muted">
                            Options: "all", "afternoon_only", "early_only", "primetime_only", or specific games
                        </small>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="prop_focus" class="form-label">Prop Focus</label>
                        <select class="form-select" id="prop_focus" name="prop_focus" required>
                            <option value="mix" {% if settings.prop_focus == "mix" %}selected{% endif %}>Mix of Overs and Unders</option>
                            <option value="overs" {% if settings.prop_focus == "overs" %}selected{% endif %}>Focus on Overs</option>
                            <option value="unders" {% if settings.prop_focus == "unders" %}selected{% endif %}>Focus on Unders</option>
                        </select>
                        <small class="form-text text-muted">
                            Choose whether to focus on over props, under props, or a balanced mix
                        </small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="min_articles_for_sentiment" class="form-label">Min Articles for Sentiment</label>
                                <input type="number" class="form-control" id="min_articles_for_sentiment"
                                       name="min_articles_for_sentiment" value="{{ settings.min_articles_for_sentiment }}"
                                       required min="1" max="10">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-4 pt-2">
                                <input class="form-check-input" type="checkbox" id="include_long_shots"
                                       name="include_long_shots" {% if settings.include_long_shots %}checked{% endif %}>
                                <label class="form-check-label" for="include_long_shots">
                                    Include Long Shots
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Game Selection Card (NEW) -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-calendar-check"></i> Select Games to Analyze</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button type="button" class="btn btn-info" id="fetchGamesBtn">
                            <i class="bi bi-cloud-download"></i> Fetch Games from ESPN
                        </button>
                        <div id="selectionSummary" class="text-muted" style="display: none;">
                            <strong><span id="selectedCount">0</span></strong> games selected
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="gamesLoading" style="display: none;" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Fetching games from ESPN...</p>
                    </div>
                    
                    <!-- Error State -->
                    <div id="gamesError" style="display: none;" class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> <span id="errorMessage"></span>
                    </div>
                    
                    <!-- Game Selection Groups -->
                    <div id="gameSelectionContainer"></div>
                </div>
            </div>
            
            <!-- Live Prompt Preview -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-eye"></i> Live Prompt (updates as you type above)</h5>
                </div>
                <div class="card-body">
                    <div id="livePromptPreview" class="code-block" style="white-space: pre-wrap; font-family: monospace; font-size: 13px; line-height: 1.6; max-height: 600px; overflow-y: auto; background-color: #f8f9fa; padding: 20px; border-radius: 4px;">{{ prompt_preview }}</div>
                </div>
            </div>
            
            <!-- Update Prompt Button -->
            <button type="button" class="btn btn-warning btn-lg w-100 mb-3" id="updatePromptBtn">
                <i class="bi bi-arrow-repeat"></i> Update Prompt Template
            </button>
            
            <!-- Generate Button -->
            <form method="POST" action="/admin/run" id="configForm">
                <input type="hidden" name="espn_game_data_link" id="hidden_espn_link">
                <input type="hidden" name="slate_description" id="hidden_slate_desc">
                <input type="hidden" name="note" id="hidden_note">
                <input type="hidden" name="focus_games" id="hidden_focus">
                <input type="hidden" name="prop_focus" id="hidden_prop_focus">
                <input type="hidden" name="min_articles_for_sentiment" id="hidden_min_articles">
                <input type="hidden" name="include_long_shots" id="hidden_long_shots">
                
                <button type="submit" class="btn btn-primary btn-lg w-100 mb-4" id="generateBtn">
                    <i class="bi bi-lightning-fill"></i> Generate Picks with This Prompt
                </button>
            </form>
            
            <!-- Progress Display -->
            <div id="progressContainer" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">
                        <h6 class="mb-0"><i class="bi bi-activity"></i> Generation Progress</h6>
                    </div>
                    <div class="card-body">
                        <div id="progressLog" class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                            <!-- Progress messages will appear here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Last Generated JSON -->
            {% if picks_json %}
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-code-square"></i> Last Generated Picks</h5>
                </div>
                <div class="card-body">
                    <div class="code-block" style="max-height: 400px; overflow-y: auto;">{{ picks_json }}</div>
                    <div class="mt-3">
                        <a href="/" class="btn btn-success">
                            <i class="bi bi-eye-fill"></i> View Dashboard
                        </a>
                        <a href="/api/picks" class="btn btn-outline-secondary" target="_blank">
                            <i class="bi bi-download"></i> Download JSON
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Store the template globally
let promptTemplate = '';
let selectedGameIds = [];
let allGames = [];

// Time slot configuration
const timeSlotConfig = {
    'early': {
        label: 'üïê EARLY GAMES (1:00 PM ET)',
        badgeClass: 'bg-primary'
    },
    'afternoon': {
        label: 'üïì AFTERNOON GAMES (4:00 PM ET)',
        badgeClass: 'bg-warning text-dark'
    },
    'night': {
        label: 'üåô NIGHT GAMES (8:00+ PM ET)',
        badgeClass: 'bg-dark'
    },
    'monday': {
        label: 'üèà MONDAY NIGHT FOOTBALL',
        badgeClass: 'bg-danger'
    },
    'thursday': {
        label: 'üèà THURSDAY NIGHT FOOTBALL',
        badgeClass: 'bg-success'
    }
};

// Fetch the prompt template from the server
async function fetchPromptTemplate() {
    try {
        const response = await fetch('/api/prompt-template');
        const data = await response.json();
        promptTemplate = data.template;
        // Update preview after fetching template
        updatePromptPreview();
    } catch (error) {
        console.error('Error fetching prompt template:', error);
        promptTemplate = 'Error loading template. Please refresh the page.';
    }
}

// Live prompt preview update function
function updatePromptPreview() {
    if (!promptTemplate) {
        return; // Wait for template to load
    }
    
    const espnLink = document.getElementById('espn_game_data_link').value;
    const slateDesc = document.getElementById('slate_description').value;
    const note = document.getElementById('note').value;
    const focusGames = document.getElementById('focus_games').value;
    const propFocus = document.getElementById('prop_focus').value;
    const minArticles = document.getElementById('min_articles_for_sentiment').value;
    const includeLongShots = document.getElementById('include_long_shots').checked;
    
    // Extract year and week from ESPN link
    const weekMatch = espnLink.match(/\/week\/(\d+)/);
    const yearMatch = espnLink.match(/\/year\/(\d+)/);
    const week = weekMatch ? weekMatch[1] : '13';
    const year = yearMatch ? yearMatch[1] : '2025';
    
    // Get current date
    const currentDate = new Date().toISOString().split('T')[0];
    
    // Replace all variables in the template
    let preview = promptTemplate
        .replace(/\{\{SLATE_DESCRIPTION\}\}/g, slateDesc)
        .replace(/\{\{NOTE\}\}/g, note)
        .replace(/\{\{FOCUS_GAMES\}\}/g, focusGames)
        .replace(/\{\{PROP_FOCUS\}\}/g, propFocus)
        .replace(/\{\{MIN_ARTICLES_FOR_SENTIMENT\}\}/g, minArticles)
        .replace(/\{\{INCLUDE_LONG_SHOTS\}\}/g, includeLongShots.toString())
        .replace(/\{\{ESPN_GAME_DATA_LINK\}\}/g, espnLink)
        .replace(/\{\{YEAR\}\}/g, year)
        .replace(/\{\{WEEK_NUMBER\}\}/g, week)
        .replace(/\{\{DATE\}\}/g, currentDate);
    
    // Update the live preview section
    const previewElement = document.getElementById('livePromptPreview');
    if (previewElement) {
        previewElement.textContent = preview;
    }
}

// Copy form values to hidden fields before submission
function copyFormValuesToHidden() {
    document.getElementById('hidden_espn_link').value = document.getElementById('espn_game_data_link').value;
    document.getElementById('hidden_slate_desc').value = document.getElementById('slate_description').value;
    document.getElementById('hidden_note').value = document.getElementById('note').value;
    document.getElementById('hidden_focus').value = document.getElementById('focus_games').value;
    document.getElementById('hidden_prop_focus').value = document.getElementById('prop_focus').value;
    document.getElementById('hidden_min_articles').value = document.getElementById('min_articles_for_sentiment').value;
    document.getElementById('hidden_long_shots').value = document.getElementById('include_long_shots').checked;
}

// Show loading state and progress when form is submitted
document.getElementById('configForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Copy form values to hidden fields
    copyFormValuesToHidden();
    
    const btn = document.getElementById('generateBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressLog = document.getElementById('progressLog');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
    
    // Show progress container
    progressContainer.style.display = 'block';
    progressLog.innerHTML = '';
    
    // Add progress message
    function addProgress(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const colors = {
            'info': 'text-primary',
            'success': 'text-success',
            'error': 'text-danger',
            'warning': 'text-warning'
        };
        const color = colors[type] || 'text-dark';
        progressLog.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
        progressLog.scrollTop = progressLog.scrollHeight;
    }
    
    // Create FormData from the form
    const formData = new FormData(this);
    
    // Start progress tracking
    addProgress('üöÄ Starting generation process...', 'info');
    addProgress('üìä Fetching ESPN game data...', 'info');
    
    // First, fetch game data to show it
    fetch('/api/games')
        .then(response => response.json())
        .then(data => {
            addProgress(`‚úÖ Found ${data.games.length} games`, 'success');
            data.games.forEach((game, i) => {
                addProgress(`   ${i + 1}. ${game.matchup} - ${game.time}`, 'info');
            });
            addProgress('ü§ñ Preparing AI prompt...', 'info');
            addProgress('üìù Sending to OpenAI for analysis...', 'info');
            
            // Now submit the form
            return fetch('/admin/run', {
                method: 'POST',
                body: formData
            });
        })
        .then(response => {
            if (response.redirected) {
                addProgress('‚úÖ Generation complete!', 'success');
                addProgress('üîÑ Redirecting to results...', 'info');
                setTimeout(() => {
                    window.location.href = response.url;
                }, 1000);
            } else {
                throw new Error('Generation failed');
            }
        })
        .catch(error => {
            addProgress(`‚ùå Error: ${error.message}`, 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-lightning-fill"></i> Generate Picks with This Prompt';
        });
});

// Update Prompt Button Handler
document.getElementById('updatePromptBtn').addEventListener('click', function() {
    const btn = this;
    const originalText = btn.innerHTML;
    
    // Disable button and show loading state
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
    
    // Get current form values
    const espnLink = document.getElementById('espn_game_data_link').value;
    const slateDesc = document.getElementById('slate_description').value;
    const note = document.getElementById('note').value;
    const focusGames = document.getElementById('focus_games').value;
    const propFocus = document.getElementById('prop_focus').value;
    const minArticles = document.getElementById('min_articles_for_sentiment').value;
    const includeLongShots = document.getElementById('include_long_shots').checked;
    
    // Create form data
    const formData = new FormData();
    formData.append('espn_game_data_link', espnLink);
    formData.append('slate_description', slateDesc);
    formData.append('note', note);
    formData.append('focus_games', focusGames);
    formData.append('prop_focus', propFocus);
    formData.append('min_articles_for_sentiment', minArticles);
    formData.append('include_long_shots', includeLongShots);
    
    // Send update request
    fetch('/admin/update-config', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Re-fetch the template from server to get updated version
            return fetchPromptTemplate();
        } else {
            throw new Error(data.error || 'Update failed');
        }
    })
    .then(() => {
        // Show success message
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-success');
        btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Updated!';
        
        // Reset button after 2 seconds
        setTimeout(() => {
            btn.classList.remove('btn-success');
            btn.classList.add('btn-warning');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 2000);
    })
    .catch(error => {
        console.error('Error:', error);
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-danger');
        btn.innerHTML = '<i class="bi bi-x-circle-fill"></i> Error!';
        
        setTimeout(() => {
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-warning');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 2000);
    });
});

// Add event listeners to all form inputs for live preview
const formInputs = [
    'espn_game_data_link',
    'slate_description',
    'note',
    'focus_games',
    'prop_focus',
    'min_articles_for_sentiment',
    'include_long_shots'
];

formInputs.forEach(inputId => {
    const element = document.getElementById(inputId);
    if (element) {
        // Use 'input' event for real-time updates as user types
        element.addEventListener('input', updatePromptPreview);
        // Also handle 'change' for checkboxes and selects
        element.addEventListener('change', updatePromptPreview);
    }
});

// Fetch and display games
async function fetchAndDisplayGames() {
    const container = document.getElementById('gameSelectionContainer');
    const loading = document.getElementById('gamesLoading');
    const errorDiv = document.getElementById('gamesError');
    const fetchBtn = document.getElementById('fetchGamesBtn');
    
    // Show loading state
    loading.style.display = 'block';
    errorDiv.style.display = 'none';
    container.innerHTML = '';
    fetchBtn.disabled = true;
    
    try {
        const response = await fetch('/api/games');
        const data = await response.json();
        
        allGames = data.games;
        const timeSlots = data.time_slots;
        
        // Hide loading
        loading.style.display = 'none';
        fetchBtn.disabled = false;
        
        // Render time slot groups
        const slotsOrder = ['early', 'afternoon', 'night', 'thursday', 'monday'];
        
        for (const slot of slotsOrder) {
            const games = timeSlots[slot];
            if (!games || games.length === 0) continue;
            
            const config = timeSlotConfig[slot];
            const slotDiv = document.createElement('div');
            slotDiv.className = 'game-time-slot mb-4';
            slotDiv.innerHTML = `
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <h6 class="mb-0">
                        <span class="badge ${config.badgeClass}">${config.label}</span>
                        <small class="text-muted ms-2">(<span class="slot-count-${slot}">0</span>/${games.length} selected)</small>
                    </h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary select-all-btn" data-slot="${slot}">
                            <i class="bi bi-check-all"></i> Select All
                        </button>
                        <button class="btn btn-outline-secondary deselect-all-btn" data-slot="${slot}">
                            <i class="bi bi-x"></i> Deselect All
                        </button>
                    </div>
                </div>
                <div class="game-checkboxes ps-3" id="slot-${slot}"></div>
            `;
            
            container.appendChild(slotDiv);
            
            // Add game checkboxes
            const checkboxContainer = document.getElementById(`slot-${slot}`);
            games.forEach(game => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'form-check mb-2';
                checkboxDiv.innerHTML = `
                    <input class="form-check-input game-checkbox"
                           type="checkbox"
                           value="${game.game_id}"
                           id="game_${game.game_id}"
                           data-time-slot="${slot}">
                    <label class="form-check-label" for="game_${game.game_id}">
                        <strong>${game.matchup}</strong> - ${game.time}
                        ${game.day_of_week ? `<small class="text-muted">(${game.day_of_week})</small>` : ''}
                    </label>
                `;
                checkboxContainer.appendChild(checkboxDiv);
            });
        }
        
        // Attach event listeners
        attachGameSelectionListeners();
        
        // Show selection summary
        document.getElementById('selectionSummary').style.display = 'block';
        
    } catch (error) {
        loading.style.display = 'none';
        fetchBtn.disabled = false;
        errorDiv.style.display = 'block';
        document.getElementById('errorMessage').textContent = error.message || 'Failed to fetch games';
    }
}

// Attach event listeners to game selection elements
function attachGameSelectionListeners() {
    // Individual checkbox listeners
    document.querySelectorAll('.game-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedGames);
    });
    
    // Select all buttons
    document.querySelectorAll('.select-all-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const slot = this.dataset.slot;
            document.querySelectorAll(`input[data-time-slot="${slot}"]`).forEach(cb => {
                cb.checked = true;
            });
            updateSelectedGames();
        });
    });
    
    // Deselect all buttons
    document.querySelectorAll('.deselect-all-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const slot = this.dataset.slot;
            document.querySelectorAll(`input[data-time-slot="${slot}"]`).forEach(cb => {
                cb.checked = false;
            });
            updateSelectedGames();
        });
    });
}

// Update selected games and send to backend
async function updateSelectedGames() {
    // Collect all checked game IDs
    selectedGameIds = Array.from(document.querySelectorAll('.game-checkbox:checked'))
        .map(cb => cb.value);
    
    // Update selection summary
    document.getElementById('selectedCount').textContent = selectedGameIds.length;
    
    // Update per-slot counts
    ['early', 'afternoon', 'night', 'thursday', 'monday'].forEach(slot => {
        const slotCheckboxes = document.querySelectorAll(`input[data-time-slot="${slot}"]`);
        const slotSelected = Array.from(slotCheckboxes).filter(cb => cb.checked).length;
        const countElement = document.querySelector(`.slot-count-${slot}`);
        if (countElement) {
            countElement.textContent = slotSelected;
        }
    });
    
    // Send selected games to backend
    try {
        await fetch('/api/games/select', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                game_ids: selectedGameIds
            })
        });
    } catch (error) {
        console.error('Error saving game selection:', error);
    }
}

// Fetch games button handler
document.getElementById('fetchGamesBtn').addEventListener('click', fetchAndDisplayGames);

// Initial setup on page load
document.addEventListener('DOMContentLoaded', function() {
    // Fetch template first, then update preview
    fetchPromptTemplate();
});
</script>
{% endblock %}